name: OpenWrt Builder

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: '源码仓库'
        required: true
        default: 'openwrt/openwrt'
        type: string
      source_branch:
        description: '源码分支'
        required: true
        default: 'main'
        type: string
      custom_feeds:
        description: '自定义软件源（每行一个）'
        required: false
        default: ''
        type: string
      target:
        description: '目标架构'
        required: true
        default: 'airoha'
        type: string
      subtarget:
        description: '芯片系列'
        required: true
        default: 'an7581'
        type: string
      profile:
        description: '设备配置'
        required: true
        default: 'nokia_xg-040g-md'
        type: string
      packages:
        description: '定制软件'
        required: false
        default: 'luci-theme-argon,luci-app-diskman,luci-app-usb-printer,tailscale,luci-app-wol,luci-app-pbr,luci-app-ttyd,luci-app-adblock,luci-i18n-base-zh-cn'
        type: string

jobs:
  build-firmware:
    name: 构建 ${{ github.event.inputs.profile }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write

    steps:
    - name: 初始化环境
      run: |
        echo "BUILD_DATE_HOUR=$(date +%Y%m%d%H)" >> $GITHUB_ENV
        echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
        echo "SUBTARGET=${{ github.event.inputs.subtarget }}" >> $GITHUB_ENV
        echo "PROFILE=${{ github.event.inputs.profile }}" >> $GITHUB_ENV

    - name: 准备源码工作区
      run: |
        sudo mkdir -p /mnt/openwrt
        sudo chown -R runner:runner /mnt/openwrt
        cd /mnt/openwrt
        git clone --depth=1 --branch ${{ github.event.inputs.source_branch }} https://github.com/${{ github.event.inputs.source_repo }}.git openwrt-src
        cd openwrt-src

    - name: 添加自定义软件源
      if: github.event.inputs.custom_feeds != ''
      run: |
        cd /mnt/openwrt/openwrt-src
        echo "${{ github.event.inputs.custom_feeds }}" | sed 's/\\n/\n/g' >> feeds.conf.default

    - name: 安装编译工具
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc g++ binutils libncurses5-dev libncursesw5-dev libssl-dev zlib1g-dev git file wget python3 python3-pip python3-setuptools rsync subversion unzip flex bison patch time jq aria2 gawk gettext libelf-dev libtool automake autoconf pkg-config zip gh
        sudo apt-get clean

    - name: 更新feeds
      run: |
        cd /mnt/openwrt/openwrt-src
        max_retries=3
        for i in $(seq 1 $max_retries); do
          timeout 300 ./scripts/feeds update -a
          if [ $? -eq 0 ]; then
            break
          elif [ $i -eq $max_retries ]; then
            echo "feeds更新失败，但继续构建过程"
          else
            sleep 10
          fi
        done
        ./scripts/feeds install -a

    - name: 生成配置
      run: |
        cd /mnt/openwrt/openwrt-src
        set -e
        > .config
        echo "CONFIG_TARGET_${TARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${PROFILE}=y" >> .config
        make defconfig
        
        > /tmp/added_packages.txt
        > /tmp/missing_packages.txt
        
        if [ -n "${{ github.event.inputs.packages }}" ]; then
          echo "${{ github.event.inputs.packages }}" | tr ',' '\n' | while read -r pkg; do
            pkg=$(echo "$pkg" | xargs)
            [ -z "$pkg" ] && continue
            
            if ./scripts/feeds install "$pkg" 2>&1; then
              pkg_config="CONFIG_PACKAGE_${pkg}"
              if grep -q "^${pkg_config}=" .config; then
                sed -i "s/^${pkg_config}=.*/${pkg_config}=y/" .config
              else
                echo "${pkg_config}=y" >> .config
              fi
              echo "$pkg" >> /tmp/added_packages.txt
            else
              echo "$pkg" >> /tmp/missing_packages.txt
            fi
          done
          
          ADDED_PACKAGES=$(cat /tmp/added_packages.txt)
          MISSING_PACKAGES=$(cat /tmp/missing_packages.txt)
        fi
        
        make defconfig
        echo "成功添加的软件包："
        if [ -s /tmp/added_packages.txt ]; then
          cat /tmp/added_packages.txt
        else
          echo "无"
        fi
        
        echo "添加失败的软件包："
        if [ -s /tmp/missing_packages.txt ]; then
          cat /tmp/missing_packages.txt
        else
          echo "无"
        fi
        
        rm -f /tmp/added_packages.txt /tmp/missing_packages.txt

    - name: 下载源码
      run: |
        cd /mnt/openwrt/openwrt-src
        set -e
        max_retries=3
        for i in $(seq 1 $max_retries); do
          make download -j$(nproc)
          if [ $? -eq 0 ]; then
            break
          elif [ $i -eq $max_retries ]; then
            echo "源码下载失败，达到最大重试次数"
            exit 1
          else
            sleep 30
          fi
        done

    - name: 编译固件
      run: |
        cd /mnt/openwrt/openwrt-src
        set -e
        make -j$(nproc) V=sc

    - name: 准备发布文件
      if: success()
      run: |
        rm -rf ${{ github.workspace }}/release_assets
        mkdir -p ${{ github.workspace }}/release_assets
        cp -r /mnt/openwrt/openwrt-src/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/* ${{ github.workspace }}/release_assets/
        
        cd /mnt/openwrt/openwrt-src/bin
        if [ -d "packages" ]; then
          zip -r ${{ github.workspace }}/release_assets/packages_${{ env.TARGET }}_${{ env.SUBTARGET }}.zip packages/
        else
          echo "警告：packages目录不存在，跳过打包"
        fi
        
        ls -lh ${{ github.workspace }}/release_assets/

    - name: 上传固件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.PROFILE }}-${{ env.BUILD_DATE_HOUR }}
        path: ${{ github.workspace }}/release_assets/
        retention-days: 7

    - name: 创建发布
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RELEASE_NOTES="设备: ${{ env.PROFILE }}
架构: ${{ env.TARGET }}/${{ env.SUBTARGET }}
定制软件: ${{ github.event.inputs.packages }}"
        
        gh release create \
          "openwrt-${{ env.PROFILE }}-${{ env.BUILD_DATE_HOUR }}" \
          --title "OpenWrt ${{ env.PROFILE }} ${{ env.BUILD_DATE_HOUR }}" \
          --notes "$RELEASE_NOTES" \
          ${{ github.workspace }}/release_assets/*
